<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RingCentral SDK Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
    </style>
</head>
<body>
    <h1>RingCentral SDK Load Test</h1>
    <div id="status">
        <div id="sdk-status" class="status loading">Testing RingCentral SDK loading...</div>
        <div id="webphone-status" class="status"></div>
        <div id="test-results"></div>
    </div>

    <script>
        const statusEl = document.getElementById('sdk-status');
        const webphoneStatusEl = document.getElementById('webphone-status');
        const resultsEl = document.getElementById('test-results');

        function updateStatus(element, message, type = 'info') {
            element.textContent = message;
            element.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function testSDK() {
            // Test RingCentral SDK
            if (typeof RingCentral === 'undefined') {
                updateStatus(statusEl, '‚ùå RingCentral SDK not loaded', 'error');
                return false;
            }
            updateStatus(statusEl, '‚úÖ RingCentral SDK loaded successfully', 'success');
            
            // Test WebPhone
            webphoneStatusEl.textContent = 'Testing RingCentral WebPhone...';
            webphoneStatusEl.className = 'status loading';
            
            if (typeof RingCentralWebPhone === 'undefined') {
                updateStatus(webphoneStatusEl, '‚ùå RingCentral WebPhone not loaded', 'error');
                return false;
            }
            updateStatus(webphoneStatusEl, '‚úÖ RingCentral WebPhone loaded successfully', 'success');
            
            return true;
        }

        // Try to load SDKs with multiple fallbacks
        function loadSDKs() {
            const sources = [
                // Using locally downloaded files
                {
                    sdk: '/lib/ringcentral/ringcentral.min.js',
                    webphone: '/lib/ringcentral-web-phone.min.js',
                    name: 'Local Files'
                },
                // Fallback to direct unpkg (in case local files are missing)
                {
                    sdk: 'https://unpkg.com/@ringcentral/sdk@4.6.0/build/umd/ringcentral.min.js',
                    webphone: 'https://unpkg.com/ringcentral-web-phone@1.13.0/dist/ringcentral-web-phone.min.js',
                    name: 'unpkg CDN'
                }
            ];

            function tryLoad(index) {
                if (index >= sources.length) {
                    const errorMsg = '‚ùå Failed to load RingCentral SDK from all sources. Please check your internet connection and try again.';
                    updateStatus(statusEl, errorMsg, 'error');
                    
                    // Add troubleshooting steps
                    resultsEl.innerHTML = `
                        <h3>Troubleshooting Steps:</h3>
                        <ol>
                            <li>Check your internet connection</li>
                            <li>Try disabling any ad blockers or content blockers</li>
                            <li>Check browser console for detailed error messages (F12 > Console)</li>
                            <li>Try in a different browser</li>
                            <li>If using a corporate network, it might be blocking CDN access</li>
                        </ol>
                    `;
                    return;
                }

                const source = sources[index];
                const sourceName = source.name || `Source ${index + 1}`;
                console.log(`Trying ${sourceName}:`, source);
                updateStatus(statusEl, `üîÑ Trying ${sourceName}...`, 'loading');
                
                // Load SDK
                const sdkScript = document.createElement('script');
                sdkScript.src = source.sdk;
                sdkScript.onload = () => {
                    // Load WebPhone
                    const webphoneScript = document.createElement('script');
                    webphoneScript.src = source.webphone;
                    // No crossorigin attribute to avoid CORS errors on some CDNs
                    webphoneScript.onload = () => {
                        if (testSDK()) {
                            showTestResults();
                        } else {
                            document.head.removeChild(sdkScript);
                            document.head.removeChild(webphoneScript);
                            tryLoad(index + 1);
                        }
                    };
                    webphoneScript.onerror = (error) => {
                        console.error(`Failed to load WebPhone from ${source.name}:`, error);
                        document.head.removeChild(sdkScript);
                        updateStatus(statusEl, `‚ùå Failed to load WebPhone from ${source.name}`, 'error');
                        setTimeout(() => tryLoad(index + 1), 500);
                    };
                    document.head.appendChild(webphoneScript);
                };
                sdkScript.onerror = (error) => {
                    console.error(`Failed to load SDK from ${source.name}:`, error);
                    updateStatus(statusEl, `‚ùå Failed to load from ${source.name}`, 'error');
                    setTimeout(() => tryLoad(index + 1), 500);
                };
                document.head.appendChild(sdkScript);
            }

            tryLoad(0);
        }

        function showTestResults() {
            const results = [];
            
            // Test RingCentral SDK
            if (typeof RingCentral === 'undefined') {
                results.push('‚ùå RingCentral SDK not available');
            } else {
                results.push('‚úÖ RingCentral SDK is available');
                results.push(`- Version: ${RingCentral.SDK.version || 'unknown'}`);
            }
            
            // Test WebPhone
            if (typeof RingCentralWebPhone === 'undefined') {
                results.push('‚ùå RingCentral WebPhone not available');
            } else {
                results.push('‚úÖ RingCentral WebPhone is available');
                results.push(`- Version: ${RingCentralWebPhone.version || 'unknown'}`);
            }
            
            // Test WebRTC
            results.push(`\nüåê WebRTC Support:`);
            results.push(`- getUserMedia: ${!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) ? '‚úÖ' : '‚ùå'}`);
            results.push(`- RTCPeerConnection: ${!!window.RTCPeerConnection ? '‚úÖ' : '‚ùå'}`);
            
            resultsEl.innerHTML = '<h3>Test Results:</h3><pre>' + results.join('\n') + '</pre>';
            
            // Add a button to test the dialer
            const testButton = document.createElement('button');
            testButton.textContent = 'Test Dialer Initialization';
            testButton.style.marginTop = '20px';
            testButton.style.padding = '10px 15px';
            testButton.style.backgroundColor = '#4CAF50';
            testButton.style.color = 'white';
            testButton.style.border = 'none';
            testButton.style.borderRadius = '4px';
            testButton.style.cursor = 'pointer';
            testButton.onclick = testDialerInitialization;
            resultsEl.appendChild(testButton);
        }
        
        function testDialerInitialization() {
            const results = [];
            results.push('\nüîß Testing Dialer Initialization...');
            
            try {
                // Test if we can create a basic SDK instance
                const sdk = new RingCentral.SDK({
                    server: 'https://platform.ringcentral.com',
                    clientId: 'test-client-id',
                    redirectUri: window.location.origin + '/rc/auth/callback'
                });
                
                results.push('‚úÖ SDK instance created successfully');
                
                // Test WebPhone initialization
                try {
                    const webphone = new RingCentralWebPhone(sdk, {
                        appName: 'Test Dialer',
                        appVersion: '1.0.0',
                        uuid: 'test-' + Math.random().toString(36).substr(2, 9),
                        logLevel: 1
                    });
                    results.push('‚úÖ WebPhone instance created successfully');
                } catch (e) {
                    results.push(`‚ùå WebPhone initialization failed: ${e.message}`);
                }
                
            } catch (e) {
                results.push(`‚ùå SDK initialization failed: ${e.message}`);
            }
            
            resultsEl.innerHTML += '<pre>' + results.join('\n') + '</pre>';
        }

        // Start the test
        loadSDKs();
    </script>
</body>
</html>
