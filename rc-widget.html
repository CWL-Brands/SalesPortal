<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RingCentral Widget</title>
  <link rel="stylesheet" href="/css/main.css" />
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .rc-container { display: grid; grid-template-columns: minmax(520px, 1fr) 300px; height: 100vh; max-width: 1100px; margin: 0 auto; }
    .rc-pane { border-left: 1px solid #eee; display: flex; flex-direction: column; }
    .rc-header { padding: 10px 12px; border-bottom: 1px solid #eee; font-weight: 600; background: #101820; color: #fff; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .rc-content { padding: 12px; display: flex; flex-direction: column; gap: 8px; height: 100%; }
    .rc-field { display: flex; flex-direction: column; gap: 6px; }
    textarea { width: 100%; min-height: 140px; resize: vertical; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .btn { background: #1a73e8; color: white; border: none; border-radius: 6px; padding: 8px 10px; cursor: pointer; font-size: 13px; }
    .btn.secondary { background: #e8eaed; color: #202124; }
    .status { font-size: 12px; color: #5f6368; }
    iframe { width: 100%; height: 100%; border: 0; }
    .actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .checkbox { display: inline-flex; gap: 6px; align-items: center; font-size: 12px; color: #5f6368; }
    /* Panel mode tweaks */
    .panel-mode .rc-container { grid-template-columns: 0 420px; max-width: 460px; }
    .panel-mode .rc-embeddable { display: none; }
    .panel-mode .rc-pane { border-left: none; width: 100%; }
    .panel-mode .rc-header { font-size: 14px; }
    .panel-mode textarea { min-height: 120px; }

    /* Overlay dialer for full RingCentral experience in panel mode */
    .rc-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .rc-overlay .sheet { width: min(920px, 96vw); height: min(720px, 92vh); background: #fff; border-radius: 10px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; }
    .rc-overlay .sheet .bar { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background:#101820; color:#fff; }
    .rc-overlay .sheet .bar .title { font-weight:600; }
    .rc-overlay .sheet .bar .close { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 6px; cursor: pointer; }
    .rc-overlay .sheet .body { flex: 1; }
  </style>
</head>
<body>
  <div class="rc-container">
    <div class="rc-embeddable">
      <!-- RingCentral Embeddable Widget -->
      <iframe id="rc-iframe" title="RingCentral" allow="microphone; speakers; camera"
        src="./kanva-call-widget/build/index.html">
      </iframe>
    </div>
    <aside class="rc-pane">
      <div class="rc-header">
        <div>Kanva Dialer + Notes</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="openDialer" class="btn" title="Open RingCentral Dialer">Open Dialer</button>
        </div>
      </div>
      <div class="rc-content">
        <div class="row"><div>Session:</div><div id="sessionId" class="status">—</div></div>
        <div class="row"><div>From:</div><div id="fromNum" class="status">—</div></div>
        <div class="row"><div>To:</div><div id="toNum" class="status">—</div></div>
        <div class="row"><div>Status:</div><div id="callStatus" class="status">idle</div></div>
        <div class="actions">
          <button id="openCopper" class="btn" disabled>Open in Copper</button>
          <label class="checkbox"><input type="checkbox" id="autoOpenCopper"> Auto-open on inbound</label>
        </div>
        <div class="rc-field">
          <label for="notes">Notes (saved on call end)</label>
          <textarea id="notes" placeholder="Type notes during/after the call..."></textarea>
        </div>
        <div class="row">
          <button id="saveNow" class="btn secondary">Save Draft</button>
          <button id="clearNotes" class="btn secondary">Clear</button>
        </div>
        <div id="saveMsg" class="status"></div>
      </div>
    </aside>
  </div>
  <!-- Overlay for full RingCentral functionality when in Copper panels -->
  <div id="rcOverlay" class="rc-overlay">
    <div class="sheet">
      <div class="bar">
        <div class="title">RingCentral</div>
        <button id="closeDialer" class="close">Close</button>
      </div>
      <div class="body">
        <iframe id="rc-iframe-overlay" title="RingCentral Full" allow="microphone; speakers; camera"
          src="./kanva-call-widget/build/index.html">
        </iframe>
      </div>
    </div>
  </div>
  <script>
    // Deployed Firebase Functions base URL
    window.RC_CONFIG = { functionsBase: 'https://kanvaportal.web.app/rc' };
    // Copper app base (US)
    window.COPPER_BASE = 'https://app.copper.com';

    // Auth guard + panel mode
    (function(){
      const params = new URLSearchParams(window.location.search);
      const panel = params.get('panel');
      if (panel === '1' || panel === 'true') {
        document.documentElement.classList.add('panel-mode');
        document.body.classList.add('panel-mode');
      }

      async function ensureAuth(){
        try{
          const res = await fetch('/rc/status', { cache: 'no-store' });
          const data = await res.json().catch(()=>({}));
          const tokens = !!(data && data.data && (data.data.tokens));
          if (!tokens){
            window.location.replace('/rc/auth/start');
          }
        }catch(e){
          // If status check fails, fail-safe to auth prompt
          window.location.replace('/rc/auth/start');
        }
      }
      document.addEventListener('DOMContentLoaded', ensureAuth);

      // Overlay toggles
      document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('rcOverlay');
        const open = document.getElementById('openDialer');
        const close = document.getElementById('closeDialer');
        if (open && overlay) open.addEventListener('click', ()=> { overlay.style.display = 'flex'; });
        if (close && overlay) close.addEventListener('click', ()=> { overlay.style.display = 'none'; });
        // Click outside sheet to close
        overlay?.addEventListener('click', (e)=>{ if (e.target === overlay) overlay.style.display = 'none'; });
      });
    })();
  </script>
  <script src="/js/ringcentral-widget.js"></script>
  <script src="/js/kanva-widget-integration.js"></script>
</body>
</html>
