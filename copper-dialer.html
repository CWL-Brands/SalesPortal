<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanva Dialer - Copper Integration</title>
    <script src="https://unpkg.com/@ringcentral/sdk@5.0.0/dist/ringcentral.min.js"></script>
    <script src="https://unpkg.com/ringcentral-web-phone@2.0.0/dist/ringcentral-web-phone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/copper-sdk@latest/dist/copper-sdk.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.5;
        }
        
        .dialer-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            margin: 0 auto 8px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }
        
        .status-dot.connected {
            background: #10b981;
        }
        
        .phone-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }
        
        .phone-input:focus {
            outline: none;
            border-color: #10b981;
        }
        
        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .number-pad button {
            aspect-ratio: 1;
            border: none;
            background: #f1f5f9;
            border-radius: 50%;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .number-pad button:hover {
            background: #e2e8f0;
            transform: scale(1.05);
        }
        
        .number-pad button:active {
            transform: scale(0.95);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #10b981;
            color: white;
        }
        
        .btn-primary:hover {
            background: #059669;
        }
        
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .customer-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        
        .customer-info.show {
            display: block;
        }
        
        .customer-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .customer-details {
            font-size: 14px;
            color: #64748b;
        }
        
        .auth-section {
            text-align: center;
            padding: 20px;
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .auth-section.hidden {
            display: none;
        }
        
        .call-controls {
            display: none;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .call-controls.show {
            display: flex;
        }
        
        .call-control-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .call-control-btn.answer {
            background: #10b981;
        }
        
        .call-control-btn.decline {
            background: #ef4444;
        }
        
        .call-control-btn.mute {
            background: #6b7280;
        }
        
        .call-control-btn.hold {
            background: #f59e0b;
        }
        
        .call-timer {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 16px;
            display: none;
        }
        
        .call-timer.show {
            display: block;
        }
        
        .notes-section {
            margin-top: 16px;
        }
        
        .notes-textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
        }
        
        .copper-actions {
            display: none;
            gap: 8px;
            margin-top: 12px;
        }
        
        .copper-actions.show {
            display: flex;
        }
        
        .copper-btn {
            flex: 1;
            padding: 8px 12px;
            background: #0ea5e9;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .copper-btn:hover {
            background: #0284c7;
        }
    </style>
</head>
<body>
    <div class="dialer-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">K</div>
            <h2>Kanva Dialer</h2>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="auth-section" id="authSection">
            <p>RingCentral authentication required</p>
            <button class="btn btn-primary" id="loginButton" style="margin-top: 12px;">
                Connect RingCentral
            </button>
        </div>

        <!-- Customer Info -->
        <div class="customer-info" id="customerInfo">
            <div class="customer-name" id="customerName">-</div>
            <div class="customer-details">
                <div id="customerCompany">-</div>
                <div id="customerEmail">-</div>
            </div>
            <div class="copper-actions" id="copperActions">
                <button class="copper-btn" id="openPersonBtn">Open Person</button>
                <button class="copper-btn" id="openCompanyBtn">Open Company</button>
            </div>
        </div>

        <!-- Phone Input -->
        <input type="tel" class="phone-input" id="phoneInput" placeholder="Enter phone number">

        <!-- Number Pad -->
        <div class="number-pad">
            <button data-digit="1">1</button>
            <button data-digit="2">2</button>
            <button data-digit="3">3</button>
            <button data-digit="4">4</button>
            <button data-digit="5">5</button>
            <button data-digit="6">6</button>
            <button data-digit="7">7</button>
            <button data-digit="8">8</button>
            <button data-digit="9">9</button>
            <button data-digit="*">*</button>
            <button data-digit="0">0</button>
            <button data-digit="#">#</button>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" id="clearBtn">Clear</button>
            <button class="btn btn-primary" id="callBtn" disabled>Call</button>
        </div>

        <!-- Call Timer -->
        <div class="call-timer" id="callTimer">00:00</div>

        <!-- Call Controls -->
        <div class="call-controls" id="callControls">
            <button class="call-control-btn answer" id="answerBtn">üìû</button>
            <button class="call-control-btn decline" id="declineBtn">üì¥</button>
            <button class="call-control-btn mute" id="muteBtn">üîá</button>
            <button class="call-control-btn hold" id="holdBtn">‚è∏Ô∏è</button>
        </div>

        <!-- Notes Section -->
        <div class="notes-section">
            <textarea class="notes-textarea" id="callNotes" placeholder="Call notes..."></textarea>
            <button class="btn btn-secondary" id="saveNotesBtn" style="width: 100%; margin-top: 8px;">
                Save Notes
            </button>
        </div>
    </div>

    <script>
        class CopperDialer {
            constructor() {
                this.sdk = null;
                this.webPhone = null;
                this.currentCall = null;
                this.isAuthenticated = false;
                this.callTimer = null;
                this.callStartTime = null;
                this.customerData = null;
                this.copperContext = null;
                
                this.config = {
                    ringcentral: {
                        clientId: '',
                        server: 'https://platform.ringcentral.com',
                        redirectUri: `${window.location.origin}/rc/auth/callback`
                    },
                    functions: {
                        baseUrl: `${window.location.origin}/rc`
                    }
                };

                this.init();
            }

            async init() {
                console.log('üöÄ Initializing Copper Dialer...');
                
                try {
                    // Check for incoming call parameters
                    this.handleURLParameters();
                    
                    // Initialize Copper SDK
                    await this.initializeCopperSDK();
                    
                    // Load configurations
                    await this.loadConfigurations();
                    
                    // Bind events
                    this.bindEvents();
                    
                    // Check auth status
                    await this.checkAuthStatus();
                    
                    console.log('‚úÖ Copper Dialer initialized successfully');
                } catch (error) {
                    console.error('‚ùå Failed to initialize Copper Dialer:', error);
                    this.updateStatus('error', 'Initialization failed');
                }
            }

            handleURLParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const incomingNumber = urlParams.get('incoming');
                const callId = urlParams.get('callId');
                
                if (incomingNumber) {
                    console.log('üìû Handling incoming call popup for:', incomingNumber);
                    
                    // Pre-fill phone number
                    document.getElementById('phoneInput').value = this.formatPhoneNumber(incomingNumber);
                    
                    // Show incoming call UI
                    this.showIncomingCallUI(incomingNumber, callId);
                    
                    // Lookup customer immediately
                    this.lookupCustomer(incomingNumber);
                }
            }

            showIncomingCallUI(number, callId) {
                // Update status to show incoming call
                this.updateStatus('ringing', `Incoming call from ${this.formatPhoneNumber(number)}`);
                
                // Show call controls
                this.showCallControls();
                
                // Focus the window
                window.focus();
                
                // Flash the window title to get attention
                this.flashWindowTitle(`Incoming Call - ${this.formatPhoneNumber(number)}`);
            }

            flashWindowTitle(newTitle) {
                const originalTitle = document.title;
                let flashCount = 0;
                
                const flashInterval = setInterval(() => {
                    document.title = flashCount % 2 === 0 ? newTitle : originalTitle;
                    flashCount++;
                    
                    if (flashCount > 10) {
                        clearInterval(flashInterval);
                        document.title = newTitle;
                    }
                }, 500);
            }

            async initializeCopperSDK() {
                try {
                    this.sdk = await Copper.init();
                    
                    // Try to get context, but handle gracefully if no valid entity
                    try {
                        this.copperContext = await this.sdk.getContext();
                        console.log('üìã Copper context:', this.copperContext);
                        this.loadContextCustomer();
                    } catch (contextError) {
                        console.warn('‚ö†Ô∏è No Copper context available (likely in action bar):', contextError.detail || contextError.message);
                        // This is normal for action bar location - no entity context
                        this.copperContext = null;
                    }
                    
                    // Set up event listeners
                    this.sdk.on('phoneNumberClicked', ({ number }) => {
                        this.dialNumber(number);
                    });
                    
                    this.sdk.on('contextUpdated', (context) => {
                        this.copperContext = context;
                        this.loadContextCustomer();
                    });
                    
                } catch (error) {
                    console.error('‚ùå Failed to initialize Copper SDK:', error);
                    throw error;
                }
            }

            loadContextCustomer() {
                if (!this.copperContext) return;
                
                // Extract customer info from Copper context
                const entity = this.copperContext.entity;
                if (entity) {
                    this.customerData = {
                        name: entity.name || 'Unknown',
                        company: entity.company_name || entity.name,
                        email: entity.emails?.[0]?.email || '',
                        phone: entity.phone_numbers?.[0]?.number || '',
                        copperId: entity.id,
                        type: this.copperContext.entityType
                    };
                    
                    this.displayCustomerInfo();
                }
            }

            async loadConfigurations() {
                try {
                    const response = await fetch('/api/config');
                    if (response.ok) {
                        const result = await response.json();
                        const config = result.config;
                        
                        if (config.ringcentral) {
                            this.config.ringcentral.clientId = config.ringcentral.clientId || '';
                            this.config.ringcentral.server = config.ringcentral.environment === 'sandbox' 
                                ? 'https://platform.devtest.ringcentral.com' 
                                : 'https://platform.ringcentral.com';
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Config endpoint returned:', response.status, 'Using fallback config');
                        this.loadFallbackConfig();
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Config endpoint failed:', error.message, 'Using fallback config');
                    this.loadFallbackConfig();
                }
            }

            loadFallbackConfig() {
                // Fallback configuration when Cloud Functions are not accessible
                this.config.ringcentral.clientId = '2nFqvUT38Sjctdhqtrhnbn'; // Your confirmed client ID
                this.config.ringcentral.server = 'https://platform.ringcentral.com';
                console.log('üìã Using fallback RingCentral configuration');
            }

            bindEvents() {
                // Number pad
                document.querySelectorAll('[data-digit]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.addDigit(btn.dataset.digit);
                    });
                });

                // Action buttons
                document.getElementById('callBtn').addEventListener('click', () => this.makeCall());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearNumber());
                document.getElementById('loginButton').addEventListener('click', () => this.startOAuth());

                // Call controls
                document.getElementById('answerBtn').addEventListener('click', () => this.answerCall());
                document.getElementById('declineBtn').addEventListener('click', () => this.hangupCall());
                document.getElementById('muteBtn').addEventListener('click', () => this.toggleMute());
                document.getElementById('holdBtn').addEventListener('click', () => this.toggleHold());

                // Notes
                document.getElementById('saveNotesBtn').addEventListener('click', () => this.saveNotes());

                // Copper actions
                document.getElementById('openPersonBtn').addEventListener('click', () => this.openCopperRecord('person'));
                document.getElementById('openCompanyBtn').addEventListener('click', () => this.openCopperRecord('company'));

                // Phone input
                document.getElementById('phoneInput').addEventListener('input', (e) => {
                    e.target.value = this.formatPhoneNumber(e.target.value);
                });
            }

            async checkAuthStatus() {
                try {
                    const response = await fetch(`${this.config.functions.baseUrl}/status`);
                    if (response.ok) {
                        const status = await response.json();
                        this.isAuthenticated = status.data?.authenticated || false;
                        
                        if (this.isAuthenticated) {
                            await this.initializeWebPhone();
                            this.hideAuthSection();
                            this.updateStatus('connected', 'Connected');
                        } else {
                            this.showAuthSection();
                            this.updateStatus('disconnected', 'Authentication required');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error checking auth status:', error);
                    this.showAuthSection();
                    this.updateStatus('error', 'Connection error');
                }
            }

            async initializeWebPhone() {
                try {
                    const tokenResponse = await fetch(`${this.config.functions.baseUrl}/token`);
                    if (!tokenResponse.ok) throw new Error('Failed to get access token');
                    
                    const tokenData = await tokenResponse.json();
                    if (!tokenData.success || !tokenData.accessToken) {
                        throw new Error('Invalid token response');
                    }
                    
                    const sdk = new RingCentral({
                        clientId: this.config.ringcentral.clientId,
                        server: this.config.ringcentral.server
                    });

                    sdk.platform().auth().setData({ access_token: tokenData.accessToken });

                    this.webPhone = new RingCentralWebPhone(sdk, {
                        appName: 'Kanva Copper Dialer',
                        appVersion: '1.0.0',
                        uuid: this.generateUUID(),
                        logLevel: 1
                    });

                    this.setupWebPhoneEvents();
                    this.enableCallButton();
                    
                } catch (error) {
                    console.error('‚ùå Failed to initialize WebPhone:', error);
                    this.showAuthSection();
                }
            }

            setupWebPhoneEvents() {
                if (!this.webPhone) return;

                this.webPhone.userAgent.on('invite', (session) => {
                    console.log('üìû Incoming call:', session);
                    this.handleIncomingCall(session);
                });

                this.webPhone.userAgent.on('connected', (session) => {
                    console.log('‚úÖ Call connected:', session);
                    this.handleCallConnected(session);
                });

                this.webPhone.userAgent.on('disconnected', (session) => {
                    console.log('üì¥ Call ended:', session);
                    this.handleCallEnded(session);
                });
            }

            handleIncomingCall(session) {
                this.currentCall = session;
                const callerNumber = this.extractPhoneNumber(session.request.from.uri.user);
                
                // Auto-popup window for incoming call
                this.autoPopupForIncomingCall(callerNumber);
                
                // Show call controls
                this.showCallControls();
                this.updateStatus('ringing', `Incoming call from ${this.formatPhoneNumber(callerNumber)}`);
                
                // Lookup caller in Copper
                this.lookupCustomer(callerNumber);
            }

            autoPopupForIncomingCall(callerNumber) {
                // If running in background or minimized, open popup window
                if (document.hidden || !document.hasFocus()) {
                    const popupUrl = `${window.location.origin}/copper-dialer.html?incoming=${callerNumber}`;
                    const popup = window.open(
                        popupUrl, 
                        'kanva-incoming-call',
                        'width=420,height=600,resizable=yes,scrollbars=yes,status=yes'
                    );
                    
                    if (popup) {
                        popup.focus();
                        // Pass call session to popup
                        popup.addEventListener('load', () => {
                            popup.copperDialer.receiveIncomingCall(this.currentCall, callerNumber);
                        });
                    }
                }
                
                // Browser notification as backup
                if (Notification.permission === 'granted') {
                    new Notification('Incoming Call', {
                        body: `Call from ${this.formatPhoneNumber(callerNumber)}`,
                        icon: '/assets/logo/kanva-logo.png',
                        tag: 'incoming-call',
                        actions: [
                            { action: 'answer', title: 'Answer' },
                            { action: 'decline', title: 'Decline' }
                        ]
                    });
                }
            }

            receiveIncomingCall(session, callerNumber) {
                // Method for popup window to receive call session
                this.currentCall = session;
                this.handleIncomingCall(session);
            }

            handleCallConnected(session) {
                this.currentCall = session;
                this.callStartTime = new Date();
                this.startCallTimer();
                this.updateStatus('connected', 'Call in progress');
            }

            handleCallEnded(session) {
                this.stopCallTimer();
                this.hideCallControls();
                this.updateStatus('connected', 'Connected');
                
                // Save notes and log call
                if (document.getElementById('callNotes').value) {
                    this.saveNotes();
                    this.logCallToCopper();
                }
                
                this.currentCall = null;
                this.callStartTime = null;
            }

            async makeCall() {
                const phoneNumber = document.getElementById('phoneInput').value.replace(/\D/g, '');
                if (!phoneNumber || !this.webPhone) return;

                try {
                    // Lookup customer before calling
                    await this.lookupCustomer(phoneNumber);
                    
                    const session = this.webPhone.userAgent.invite(`+1${phoneNumber}`);
                    this.currentCall = session;
                    this.updateStatus('calling', `Calling ${this.formatPhoneNumber(phoneNumber)}...`);
                    
                } catch (error) {
                    console.error('‚ùå Call failed:', error);
                    this.updateStatus('error', 'Call failed');
                }
            }

            async lookupCustomer(phoneNumber) {
                try {
                    const response = await fetch(`${this.config.functions.baseUrl}/copper/lookup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone: phoneNumber.replace(/\D/g, '') })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.copperId) {
                            this.customerData = result;
                            this.displayCustomerInfo();
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Customer lookup failed:', error);
                }
            }

            displayCustomerInfo() {
                if (!this.customerData) return;
                
                document.getElementById('customerName').textContent = this.customerData.name || 'Unknown';
                document.getElementById('customerCompany').textContent = this.customerData.company || '-';
                document.getElementById('customerEmail').textContent = this.customerData.email || '-';
                
                document.getElementById('customerInfo').classList.add('show');
                document.getElementById('copperActions').classList.add('show');
            }

            openCopperRecord(type) {
                if (!this.customerData) return;
                
                const recordId = this.customerData.copperId;
                if (recordId) {
                    // Use Copper SDK to navigate
                    this.sdk.navigateToEntityDetail(type, recordId);
                }
            }

            async saveNotes() {
                const notes = document.getElementById('callNotes').value;
                if (!notes) return;

                try {
                    await fetch(`${this.config.functions.baseUrl}/notes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: this.currentCall?.id || `draft-${Date.now()}`,
                            notes: notes,
                            customerData: this.customerData
                        })
                    });
                    
                    // Also log to Copper using SDK
                    if (this.sdk && this.customerData) {
                        await this.sdk.logActivity({
                            type: 'note',
                            details: notes,
                            parent: {
                                id: this.customerData.copperId,
                                type: this.customerData.type
                            }
                        });
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to save notes:', error);
                }
            }

            async logCallToCopper() {
                if (!this.customerData || !this.currentCall) return;
                
                try {
                    const phoneNumber = this.extractPhoneNumber(
                        this.currentCall.request?.from?.uri?.user || 
                        this.currentCall.request?.to?.uri?.user || ''
                    );
                    
                    await fetch(`${this.config.functions.baseUrl}/copper/log-call`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: this.currentCall.id,
                            from: this.currentCall.direction === 'Inbound' ? phoneNumber : 'agent',
                            to: this.currentCall.direction === 'Outbound' ? phoneNumber : 'agent',
                            direction: this.currentCall.direction || 'Outbound',
                            notes: document.getElementById('callNotes').value,
                            startTime: this.callStartTime?.toISOString(),
                            endTime: new Date().toISOString()
                        })
                    });
                    
                } catch (error) {
                    console.error('‚ùå Failed to log call:', error);
                }
            }

            // UI Helper Methods
            dialNumber(number) {
                const input = document.getElementById('phoneInput');
                input.value = this.formatPhoneNumber(number);
                if (this.isAuthenticated) {
                    this.makeCall();
                }
            }

            addDigit(digit) {
                const input = document.getElementById('phoneInput');
                input.value += digit;
                input.value = this.formatPhoneNumber(input.value);
            }

            clearNumber() {
                document.getElementById('phoneInput').value = '';
            }

            formatPhoneNumber(phone) {
                const cleaned = phone.replace(/\D/g, '');
                const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
                if (match) {
                    return `(${match[1]}) ${match[2]}-${match[3]}`;
                }
                return phone;
            }

            extractPhoneNumber(input) {
                return input ? input.replace(/\D/g, '') : '';
            }

            updateStatus(status, text) {
                const dot = document.getElementById('statusDot');
                const textEl = document.getElementById('statusText');
                
                dot.className = `status-dot ${status === 'connected' ? 'connected' : ''}`;
                textEl.textContent = text;
            }

            showAuthSection() {
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('callBtn').disabled = true;
            }

            hideAuthSection() {
                document.getElementById('authSection').classList.add('hidden');
            }

            enableCallButton() {
                document.getElementById('callBtn').disabled = false;
            }

            showCallControls() {
                document.getElementById('callControls').classList.add('show');
            }

            hideCallControls() {
                document.getElementById('callControls').classList.remove('show');
            }

            startCallTimer() {
                this.callTimer = setInterval(() => {
                    if (this.callStartTime) {
                        const elapsed = Math.floor((new Date() - this.callStartTime) / 1000);
                        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                        const seconds = (elapsed % 60).toString().padStart(2, '0');
                        document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
                        document.getElementById('callTimer').classList.add('show');
                    }
                }, 1000);
            }

            stopCallTimer() {
                if (this.callTimer) {
                    clearInterval(this.callTimer);
                    this.callTimer = null;
                }
                document.getElementById('callTimer').classList.remove('show');
            }

            answerCall() {
                if (this.currentCall) {
                    this.currentCall.accept();
                }
            }

            hangupCall() {
                if (this.currentCall) {
                    this.currentCall.terminate();
                }
            }

            toggleMute() {
                if (this.currentCall) {
                    const isMuted = this.currentCall.isMuted();
                    if (isMuted) {
                        this.currentCall.unmute();
                    } else {
                        this.currentCall.mute();
                    }
                    
                    const btn = document.getElementById('muteBtn');
                    btn.textContent = isMuted ? 'üîá' : 'üîä';
                }
            }

            toggleHold() {
                if (this.currentCall) {
                    const isOnHold = this.currentCall.isOnHold();
                    if (isOnHold) {
                        this.currentCall.unhold();
                    } else {
                        this.currentCall.hold();
                    }
                    
                    const btn = document.getElementById('holdBtn');
                    btn.textContent = isOnHold ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                }
            }

            startOAuth() {
                if (!this.config.ringcentral.clientId) {
                    console.error('RingCentral not configured. Please contact administrator.');
                    this.updateStatus('error', 'RingCentral not configured');
                    return;
                }
                
                const authUrl = `${window.location.origin}/rc/auth/start`;
                
                try {
                    // For iframe context, use postMessage to request parent to open popup
                    if (window.parent && window.parent !== window) {
                        console.log('üîÑ Requesting parent window to open OAuth popup...');
                        
                        // Send message to parent to open popup
                        window.parent.postMessage({
                            type: 'OPEN_OAUTH_POPUP',
                            url: authUrl,
                            windowName: 'ringcentral-oauth',
                            features: 'width=500,height=600,resizable=yes,scrollbars=yes'
                        }, '*');
                        
                        this.updateStatus('authenticating', 'Opening authentication window...');
                        
                        // Listen for auth completion message
                        const messageHandler = (event) => {
                            if (event.data && event.data.type === 'OAUTH_COMPLETE') {
                                window.removeEventListener('message', messageHandler);
                                setTimeout(() => this.checkAuthStatus(), 2000);
                            }
                        };
                        window.addEventListener('message', messageHandler);
                        
                        // Fallback timeout
                        setTimeout(() => {
                            window.removeEventListener('message', messageHandler);
                            this.checkAuthStatus();
                        }, 30000);
                        
                    } else {
                        // Direct popup for non-iframe context
                        const popup = window.open(authUrl, 'ringcentral-oauth', 'width=500,height=600,resizable=yes,scrollbars=yes');
                        
                        if (!popup) {
                            console.error('Popup blocked. Please allow popups and try again.');
                            this.updateStatus('error', 'Popup blocked - please allow popups');
                            return;
                        }
                        
                        this.updateStatus('authenticating', 'Opening authentication window...');
                        
                        // Monitor popup closure
                        const checkClosed = setInterval(() => {
                            try {
                                if (popup.closed) {
                                    clearInterval(checkClosed);
                                    setTimeout(() => this.checkAuthStatus(), 2000);
                                }
                            } catch (e) {
                                clearInterval(checkClosed);
                                setTimeout(() => this.checkAuthStatus(), 5000);
                            }
                        }, 1000);
                    }
                    
                } catch (error) {
                    console.error('OAuth popup failed:', error);
                    this.updateStatus('error', `OAuth failed: ${error.message}`);
                }
            }

            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.copperDialer = new CopperDialer();
            
            // Register service worker for background call detection
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/dialer-service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration);
                        
                        // Request notification permission
                        if (Notification.permission === 'default') {
                            Notification.requestPermission().then(permission => {
                                console.log('üì± Notification permission:', permission);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker registration failed:', error);
                    });
            }
        });
    </script>
</body>
</html>
